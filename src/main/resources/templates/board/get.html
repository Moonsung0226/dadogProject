<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시물 상세보기</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>


</head>
<body>
<div class="container">
    <h1 th:text="${board.boardTitle}"></h1>
    <p><strong>작성자:</strong> <span th:text="${board.boardWriter}"></span></p>
    <p><strong>내용:</strong> <span th:text="${board.boardContent}"></span></p>
    <p><strong>조회수:</strong> <span th:text="${board.boardViews}"></span></p>
    <p><strong>작성/수정일:</strong> <span th:text="${board.createTime}"></span></p>

    <div th:if="${userId == board.boardWriter}">
        <a th:href="@{/dadog/boards/{boardNo}/update(boardNo=${board.boardNo})}" class="btn btn-warning">수정</a>

        <form th:action="@{/dadog/boards/{boardNo}/delete(boardNo=${board.boardNo})}" method="post" style="display:inline;">

            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/> <!-- CSRF 토큰 -->

            <button type="submit" class="btn btn-danger" onclick="return confirm();">삭제</button>
        </form>
    </div>

    <!-- 댓글 목록 -->
    <h3>댓글 목록</h3>
    <ul id="replyList" class="list-group">
        <li class="list-group-item" th:each="reply : ${replies}" th:data-id="${reply.replyNo}">
            <strong th:text="${reply.replyWriter}"></strong>
            <span th:text="${reply.replyContent}"></span>
            <span th:text="${reply.createTime != null ? #temporals.format(reply.createTime, 'yyyy-MM-dd HH:mm:ss') : ''}"></span> <!-- 날짜 포맷 -->

            <button class="btn btn-warning btn-sm float-end update-btn">수정</button>
            <form th:action="@{/dadog/boards/reply/{boardNo}/delete/{replyNo}(boardNo=${board.boardNo}, replyNo=${reply.replyNo})}" method="post" style="display:inline;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/> <!-- CSRF Token -->
                <button type="submit" class="btn btn-danger btn-sm float-end delete-btn" onclick="return confirm();">삭제</button>
            </form>
        </li>
    </ul>

    <!-- 댓글 추가 폼 -->
    <h4>댓글 추가</h4>
    <form id="addReplyForm" th:action="@{/dadog/boards/reply/{boardNo}/add(boardNo=${board.boardNo})}" method="post">
        <!-- 게시물 번호를 숨긴 필드로 처리 -->
        <input type="hidden" id="boardNo" th:value="${board.boardNo}">
        <input type="hidden" id="csrfToken" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/> <!-- CSRF 토큰 추가 -->
        <input type="hidden" id="csrfHeader" th:value="${_csrf.headerName}"/>
        <input type="hidden" id="userNo" th:value="${userNo}"/>
        <input type="hidden" id="replyWriter" th:value="${userId}">


        <div class="form-group">
            <label for="replyContent">댓글 내용:</label>
            <input type="text" class="form-control" id="replyContent" required>
        </div>
        <button type="submit" class="btn btn-primary" th:formaction="@{/dadog/boards/${replyDTO.boardNo}/reply}" onsubmit="return addReply(e)">댓글 추가</button>
    </form>
</div>

<script>
    $(document).ready(function() {

        const csrfToken = $('#csrfToken').val(); // CSRF 토큰 가져오기
        const csrfHeader = $('#csrfHeader').val(); // CSRF 헤더 가져오기
        const boardNo = $('#boardNo').val();

        console.log('CSRF Token : ' + csrfToken);
        console.log('CSRF Header : ' + csrfHeader);

        // 댓글 추가 폼의 submit 이벤트 처리
        $('#addReplyForm').submit(function(e) {
            e.preventDefault(); // 기본 폼 제출 방지

            // 폼 데이터를 객체로 만듦
            const replyData = {
                replyWriter: $('#replyWriter').val(),
                replyContent: $('#replyContent').val(),
                boardNo: $('#boardNo').val(),  // 숨겨진 필드에서 boardNo 값을 가져옴
                userNo: $('#userNo').val()
            };

            console.log(replyData); // 디버깅용 데이터 확인

            // CSRF 토큰과 헤더를 숨겨진 입력 필드에서 가져오기



            // Ajax 요청으로 댓글 추가
            $.ajax({
                type: "POST",
                url:  `/dadog/boards/reply/${replyData.boardNo}/add`, // 상대 경로 사용
                // url: `dadog/boards/reply/${replyData.boardNo}/reply`,
            contentType: "application/json", // JSON 형식으로 데이터 전송
                data: JSON.stringify(replyData), // 데이터를 JSON 문자열로 변환
                cache: false,
                beforeSend: function (xhr){
                    if (csrfToken && csrfHeader) { // 헤더와 토큰이 정의되어 있는지 확인
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    } else{
                        console.log("둘 중 하나 undefined");
                    }
                },
                success: function(response) {

                    const formattedDate = new Date(response.createTime).toLocaleString();

                    // 댓글 추가 성공 시 처리
                $('#replyList').append(`
                    <li class="list-group-item" th:data-id="${response.replyNo}">
                        <strong>${response.userNo}</strong>
                        <span>${response.replyContent}</span>
                        <span>${formattedDate}</span>
                        <button class="btn btn-warning btn-sm float-end update-btn">수정</button>
                        <form th:action="/dadog/boards/reply/${replyData.boardNo}/delete/${response.replyNo}" method="post" style="display:inline;">
                <input type="hidden" th:name="${'_csrf.parameterName'}" th:value="${'_csrf.token'}"/> <!-- CSRF Token -->
                <button type="submit" class="btn btn-danger btn-sm float-end delete-btn" onclick="return confirm('댓글을 삭제하시겠습니까?');">삭제</button>
                        </form>
                    </li>
                `);
                // 입력 필드 비우기
                $('#replyContent').val('');
                console.log('댓글 추가 성공:', response);
                    alert("댓글 등록이 완료되었습니다.");
            },
            error: function(xhr, status, error) {
                // 댓글 추가 실패 시 처리

                console.log('댓글 추가 실패:', xhr.responseText);
                alert('댓글 추가에 실패했습니다.'); // 오류 메시지 표시
            }
        });
            return false; // 추가적인 폼 제출 방지
        });
    });

    // 댓글 삭제
    $('#replyList').on('click', '.delete-btn', function(e){

        e.preventDefault();

        const replyItem = $(this).closest('li');
        const replyNo = replyItem.data('id');
        const csrfToken = $('#csrfToken').val(); // CSRF 토큰 가져오기
        const csrfHeader = $('#csrfHeader').val(); // CSRF 헤더 가져오기
        const boardNo = $('#boardNo').val();

        console.log("Reply No:", replyNo);  // 로그를 통해 replyNo 확인
        console.log("Board No:", boardNo);

        if (!replyNo || !boardNo) {
            console.error('Reply No or Board No is undefined');
            return;
        }

        if (confirm('댓글을 삭제하시겠습니까?')) {
            $.ajax({
                type: "POST",
                url: `/dadog/boards/reply/${boardNo}/delete/${replyNo}`, // 삭제 엔드포인트
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                success: function() {
                    replyItem.remove();
                    alert('댓글이 삭제되었습니다.');

                    console.log("댓글 삭제 완료");
                    //     댓글이 삭제된 후 댓글이 포함된 게시물 상세 페이지로 이동하려면, 댓글이 아닌 게시물 경로로 리다이렉트를 해야함
                    window.location.href = `/dadog/boards/${boardNo}`;
                },
                error: function(xhr, status, error) {
                    alert('댓글 삭제에 실패했습니다.');
                }
            });
        }
    });

    // 댓글 수정 버튼 클릭 이벤트
    $('#replyList').on('click', '.update-btn', function() {
        const replyItem = $(this).closest('li');
        const replyNo = replyItem.data('id');
        const replyContent = replyItem.find('span').eq(0).text();

        const newContent = prompt('댓글을 수정하세요:', replyContent);

        if (newContent !== null && newContent.trim() !== '') {
                const boardNo = $('#boardNo').val();
           // const csrfToken = $('input[name="_csrf"]').val();
            // const csrfHeader = $('input[name="_csrf_header"]').val();

            $.ajax({
                type: "POST",
                url: `/dadog/boards/reply/${boardNo}/update/${replyNo}`, // 수정 엔드포인트
                contentType: "application/json",
                data: JSON.stringify({ replyContent: newContent }),
                beforeSend: function(xhr) {
                    const csrfToken = $('#csrfToken').val(); // CSRF 토큰 가져오기
                    const csrfHeader = $('#csrfHeader').val(); // CSRF 헤더 가져오기
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                success: function() {
                    replyItem.find('span').eq(0).text(newContent);
                    alert('댓글이 수정되었습니다.');
                },
                error: function(xhr, status, error) {
                    alert('댓글 수정에 실패했습니다.');
                }
            });
        }
    });

</script>
</body>
</html>