<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시물 상세보기</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <style>
        body {
            /*background-color: #f7f7f7;*/
            font-family: 'Arial', sans-serif;
        }

        .container {
            /*background-color: #fff;*/
            padding: 20px;
            border-radius: 8px;
            /*box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);*/
            max-width: 900px;
            margin: 40px auto;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        p {
            font-size: 1rem;
            color: #555;
        }

        h3, h4 {
            font-size: 1.5rem;
            margin-top: 30px;
            margin-bottom: 20px;
            color: #007bff;
        }

        .form-group label {
            font-size: 1rem;
            font-weight: bold;
        }

        .form-control {
            border-radius: 5px;
            padding: 10px;
            font-size: 1rem;
            border: 1px solid #ddd;
        }

        .btn {
            border-radius: 5px;
            font-size: 1rem;
            padding: 8px 15px;
            margin-top: 10px;
            margin: 2px;
        }

        .btn-primary {
            background-color: #007bff;
            border: none;
        }

        .btn-warning {
            background-color: #ffc107;
            border: none;
        }

        .btn-danger {
            background-color: #dc3545;
            border: none;
        }

        .btn:hover {
            opacity: 0.85;
        }

        .list-group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .list-group-item strong {
            color: #333;
            font-size: 1.1rem;
        }

        .list-group-item span {
            font-size: 0.9rem;
            color: #666;
        }

        .list-group-item .btn {
            font-size: 0.9rem;
            padding: 5px 10px;
            /*margin: auto;*/
        }

        .update-btn, .delete-btn {
            margin-left: 10px;
        }

        /* 댓글 추가 폼 */
        #addReplyForm {
            margin-top: 20px;
            padding: 20px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .form-group label {
                font-size: 0.9rem;
            }

            .form-control {
                font-size: 0.9rem;
                width: 50%;
            }

            .btn {
                font-size: 0.9rem;
            }

            .list-group-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 5px; /* 기존 15px에서 10px으로 조정 */
                /*background-color: #f9f9f9;*/
                border: 1px solid #ddd;
                border-radius: 5px;
                margin-bottom: 10px;
                font-size: 0.9rem; /* 전체 크기 조정을 위해 폰트 크기도 줄임 */
            }

            .list-group-item strong {
                color: #333;
                font-size: 1rem; /* 기존 1.1rem에서 줄임 */
            }

            .list-group-item span {
                font-size: 0.8rem; /* 기존 0.9rem에서 줄임 */
            }

            .list-group-item .btn {
                font-size: 0.8rem; /* 버튼의 글씨 크기도 줄임 */
                padding: 4px 8px; /* 버튼의 크기 조정 */
            }
            .form-control-plaintext {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
<div layout:fragment="mainContent">
<div class="container">
    <h1 th:text="${board.boardTitle}"></h1>
    <div class="form-floating mb-3">
        <input type="text" readonly class="form-control-plaintext" id="floatingEmptyPlaintextInput boardWriter" th:value="${board.boardWriter}">
        <label for="floatingEmptyPlaintextInput boardWriter">작성자</label>
    </div>
    <div class="form-floating mb-3">
        <input type="text" readonly class="form-control-plaintext" id="floatingEmptyPlaintextInput boardContent" th:value="${board.boardContent}">
        <label for="floatingEmptyPlaintextInput boardContent">내용</label>
    </div>
    <div class="form-floating mb-3">
        <input type="text" readonly class="form-control-plaintext" id="boardViews" th:value="${board.boardViews}">
        <label for="boardViews">조회수</label>
    </div>
<!--    <div class="input-group mb-3">-->
<!--        <span class="input-group-text" id="inputGroup-sizing-default boardWriter">작성자:</span>-->
<!--        <input type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default" th:value="${board.boardWriter}">-->
<!--    </div>-->
<!--    <div class="input-group mb-3">-->
<!--        <span class="input-group-text" id="inputGroup-sizing-default boardContent">내용:</span>-->
<!--        <input type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default" th:value="${board.boardContent}">-->
<!--    </div>-->
<!--    <div class="input-group mb-3">-->
<!--        <span class="input-group-text" id="inputGroup-sizing-default boardViews">조회수:</span>-->
<!--        <input type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default" th:value="${board.createTime}">-->
<!--    </div>-->
<!--    <p><strong>작성자:</strong> <span th:text="${board.boardWriter}"></span></p>-->
<!--    <p><strong>내용:</strong> <span th:text="${board.boardContent}"></span></p>-->
<!--    <p><strong>조회수:</strong> <span th:text="${board.boardViews}"></span></p>-->
<!--    <p><strong>작성/수정일:</strong> <span th:text="${board.createTime}"></span></p>-->

    <div th:if="${userId == board.boardWriter}">
        <a th:href="@{/dadog/boards/{boardNo}/update(boardNo=${board.boardNo})}" class="btn btn-warning">수정</a>
        <form th:action="@{/dadog/boards/{boardNo}/delete(boardNo=${board.boardNo})}" method="post" style="display:inline;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/> <!-- CSRF 토큰 -->
            <button type="submit" class="btn btn-danger" onclick="return confirmDelete('게시물을 삭제하시겠습니까?');">삭제</button>
        </form>
    </div>

    <!-- 댓글 목록 -->
    <h3>댓글 목록</h3>
    <ul id="replyList" class="list-group">
        <li class="list-group-item" th:each="reply : ${replies}" th:data-id="${reply.replyNo}">
            <strong th:text="${reply.replyWriter}"></strong>
            <span th:text="${reply.replyContent}"></span>
            <span th:text="${reply.createTime != null ? #temporals.format(reply.createTime, 'yyyy-MM-dd HH:mm:ss') : ''}"></span> <!-- 날짜 포맷 -->

            <div th:if="${reply.replyWriter.equals(loggedInUserId)}">
                <!-- 댓글 작성자와 로그인한 사용자가 같을 때만 수정 및 삭제 버튼 표시 -->
                <button class="btn btn-warning btn-sm float-end update-btn">수정</button>
                <form th:action="@{/dadog/boards/reply/{boardNo}/delete/{replyNo}(boardNo=${board.boardNo}, replyNo=${reply.replyNo})}" method="post" style="display:inline;">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/> <!-- CSRF Token -->
                    <button type="submit" class="btn btn-danger btn-sm float-end delete-btn">삭제</button>
                </form>
            </div>
        </li>
    </ul>

    <!-- 댓글 추가 폼 -->
    <h4>댓글 추가</h4>
    <form id="addReplyForm">
        <input type="hidden" id="boardNo" th:value="${board.boardNo}">
        <input type="hidden" id="csrfToken" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/> <!-- CSRF 토큰 추가 -->
        <input type="hidden" id="csrfHeader" th:value="${_csrf.headerName}"/>
        <input type="hidden" id="userNo" th:value="${userNo}"/>
        <input type="hidden" id="replyWriter" th:value="${userId}"/>

        <div class="form-group">
            <label for="replyContent">댓글 내용:</label>
            <input type="text" class="form-control" id="replyContent" required>
        </div>
        <button type="submit" class="btn btn-primary">댓글 추가</button>
    </form>
</div>

<script>
    $(document).ready(function() {
        const csrfToken = $('#csrfToken').val();
        const csrfHeader = $('#csrfHeader').val();
        const userId = $('#replyWriter').val(); // 로그인한 사용자 ID

        // 댓글 추가 폼 제출 이벤트 처리
        $('#addReplyForm').submit(function(e) {
            e.preventDefault();

            const replyData = {
                replyWriter: userId,
                userNo: $('#userNo').val(), // userNo 추가
                replyContent: $('#replyContent').val(),
                boardNo: $('#boardNo').val(),
            };

            console.log(replyData);

            // Ajax 요청으로 댓글 추가
            $.ajax({
                type: "POST",
                url: `/dadog/boards/reply/${replyData.boardNo}/add`,
                contentType: "application/json",
                data: JSON.stringify(replyData),
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                success: function(response) {
                    console.log("댓글 추가 성공 응답:", response);
                    console.log('Logged in user ID:', userId);
                    console.log('Reply writer ID:', response.replyWriter);
                    const formattedDate = new Date(response.createTime).toLocaleString();
                    const replyHtml = `
                        <li class="list-group-item" data-id="${response.replyNo}">
                            <strong>${response.replyWriter}</strong>
                            <span>${response.replyContent}</span>
                            <span>${formattedDate}</span>
                            <div style="display: ${response.userNo === userNo ? 'block' : 'none'};"> <!-- userId로 비교 -->
                                <button class="btn btn-warning btn-sm float-end update-btn">수정</button>
                                <form action="/dadog/boards/reply/${replyData.boardNo}/delete/${response.replyNo}" method="post" style="display:inline;">
                                    <input type="hidden" name="_csrf" value="${csrfToken}"/>
                                    <button type="submit" class="btn btn-danger btn-sm float-end delete-btn" onclick="return confirmDelete('댓글을 삭제하시겠습니까?');">삭제</button>
                                </form>
                            </div>
                        </li>
                    `;

                    // 댓글 추가 성공 시 처리
                    $('#replyList').append(replyHtml);
                    $('#replyContent').val(''); // 입력 필드 초기화
                },
                error: function(xhr) {
                    console.log('댓글 추가 실패:', xhr.responseText);
                    alert('댓글 추가에 실패했습니다.');
                }
            });
        });

        // 댓글 삭제
        $('#replyList').on('click', '.delete-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const replyItem = $(this).closest('li');
            const replyNo = replyItem.data('id');
            const boardNo = $('#boardNo').val();

            // confirmDelete 함수를 호출하여 삭제 확인
            if (confirmDelete('댓글을 삭제하시겠습니까?')) {
                console.log("댓글 삭제 요청:", { boardNo, replyNo });
                $.ajax({
                    type: "POST",
                    url: `/dadog/boards/reply/${boardNo}/delete/${replyNo}`,
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    },
                    success: function() {
                        replyItem.remove();
                        alert('댓글이 삭제되었습니다.');
                    },
                    error: function(xhr) {
                        alert('댓글 삭제에 실패했습니다.');
                    }
                });
            }
        });

        // 댓글 수정
        $('#replyList').on('click', '.update-btn', function() {
            const replyItem = $(this).closest('li');
            const replyNo = replyItem.data('id');
            const replyContent = replyItem.find('span').eq(0).text();
            const newContent = prompt('댓글을 수정하세요:', replyContent);

            if (newContent !== null && newContent.trim() !== '') {
                const boardNo = $('#boardNo').val();

                console.log("댓글 수정 요청 데이터:", { replyNo, newContent });

                $.ajax({
                    type: "POST",
                    url: `/dadog/boards/reply/${boardNo}/update/${replyNo}`,
                    contentType: "application/json",
                    data: JSON.stringify({ replyContent: newContent }),
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    },
                    success: function() {
                        replyItem.find('span').eq(0).text(newContent);
                        alert('댓글이 수정되었습니다.');
                    },
                    error: function(xhr) {
                        alert('댓글 수정에 실패했습니다.');
                    }
                });
            }
        });
    });

    // confirmDelete 함수 정의
    function confirmDelete(message) {
        return confirm(message);
    }
</script>
</div>
</body>
</html>
