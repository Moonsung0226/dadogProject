<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시물 상세보기</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
<div class="container">
    <h1 th:text="${board.boardTitle}"></h1>
    <p><strong>작성자:</strong> <span th:text="${board.boardWriter}"></span></p>
    <p><strong>내용:</strong> <span th:text="${board.boardContent}"></span></p>
    <p><strong>조회수:</strong> <span th:text="${board.boardViews}"></span></p>
    <p><strong>작성/수정일:</strong> <span th:text="${board.createTime}"></span></p>

    <div th:if="${userId == board.boardWriter}">
        <a th:href="@{/dadog/boards/{boardNo}/update(boardNo=${board.boardNo})}" class="btn btn-warning">수정</a>
        <form th:action="@{/dadog/boards/{boardNo}/delete(boardNo=${board.boardNo})}" method="post" style="display:inline;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="btn btn-danger" onclick="return confirmDelete('게시물을 삭제하시겠습니까?');">삭제</button>
        </form>
    </div>

    <h3>댓글 목록</h3>
    <ul id="replyList" class="list-group">
        <li class="list-group-item" th:each="reply : ${replies}" th:data-id="${reply.replyNo}">
            <strong th:text="${reply.replyWriter}"></strong>
            <span th:text="${reply.replyContent}"></span>
            <span th:text="${reply.createTime != null ? #temporals.format(reply.createTime, 'yyyy-MM-dd HH:mm:ss') : ''}"></span>

            <!-- 변경 사항: 수정/삭제 버튼 표시 조건 변경 -->
            <div th:if="${reply.replyWriter.equals(loggedInUserId)}">
                <button class="btn btn-warning btn-sm float-end update-btn">수정</button>
                <form th:action="@{/dadog/boards/reply/{boardNo}/delete/{replyNo}(boardNo=${board.boardNo}, replyNo=${reply.replyNo})}" method="post" style="display:inline;">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn btn-danger btn-sm float-end delete-btn">삭제</button>
                </form>
            </div>
        </li>
    </ul>

    <h4>댓글 추가</h4>
    <form id="addReplyForm">
        <input type="hidden" id="boardNo" th:value="${board.boardNo}">
        <input type="hidden" id="csrfToken" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <input type="hidden" id="csrfHeader" th:value="${_csrf.headerName}"/>
        <input type="hidden" id="userNo" th:value="${userNo}"/>
        <input type="hidden" id="replyWriter" th:value="${userId}"/>

        <div class="form-group">
            <label for="replyContent">댓글 내용:</label>
            <input type="text" class="form-control" id="replyContent" required>
        </div>
        <button type="submit" class="btn btn-primary">댓글 추가</button>
    </form>
</div>

<script>
    $(document).ready(function() {
        const csrfToken = $('#csrfToken').val();
        const csrfHeader = $('#csrfHeader').val();
        const userId = $('#replyWriter').val();

        $('#addReplyForm').submit(function(e) {
            e.preventDefault();

            const replyData = {
                replyWriter: userId,
                userNo: $('#userNo').val(),
                replyContent: $('#replyContent').val(),
                boardNo: $('#boardNo').val(),
            };

            $.ajax({
                type: "POST",
                url: `/dadog/boards/reply/${replyData.boardNo}/add`,
                contentType: "application/json",
                data: JSON.stringify(replyData),
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                success: function(response) {

                    const formattedDate = new Date(response.createTime).toLocaleString();
                    const replyHtml = `
                        <li class="list-group-item" data-id="${response.replyNo}">
                            <strong>${response.replyWriter}</strong>
                            <span>${response.replyContent}</span>
                            <span>${formattedDate}</span>
                            <div style="display: ${response.replyWriter === userId ? 'block' : 'none'};">  <!-- userNo을 userId로 변경-->
                                <button class="btn btn-warning btn-sm float-end update-btn">수정</button>
                                <form action="/dadog/boards/reply/${replyData.boardNo}/delete/${response.replyNo}" method="post" style="display:inline;">
                                    <input type="hidden" name="_csrf" value="${csrfToken}"/>
                                    <button type="submit" class="btn btn-danger btn-sm float-end delete-btn">삭제</button>
                                </form>
                            </div>
                        </li>
                    `;

                    $('#replyList').append(replyHtml);
                    $('#replyContent').val('');
                },
                error: function(xhr) {
                    console.log('댓글 추가 실패:', xhr.responseText);
                    alert('로그인 후 이용해주세요');
                    location.href = "/dadog/members/login";
                }
            });
        });

        $(document).on('click', '.delete-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const replyItem = $(this).closest('li');
            const replyNo = replyItem.data('id');
            const boardNo = $('#boardNo').val();

            if (confirm('댓글을 삭제하시겠습니까?')) {
                $.ajax({
                    type: "POST",
                    url: `/dadog/boards/reply/${boardNo}/delete/${replyNo}`,
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    },
                    success: function() {
                        replyItem.remove();
                        alert('댓글이 삭제되었습니다.');
                    },
                    error: function(xhr) {
                        alert('댓글 삭제에 실패했습니다.');
                    }
                });
            }
        });


        $(document).on('click', '.update-btn', function() {
            const replyItem = $(this).closest('li');
            const replyNo = replyItem.data('id');
            const replyContent = replyItem.find('span').eq(0).text();
            const newContent = prompt('댓글을 수정하세요:', replyContent);

            if (newContent !== null && newContent.trim() !== '') {
                const boardNo = $('#boardNo').val();

                $.ajax({
                    type: "POST",
                    url: `/dadog/boards/reply/${boardNo}/update/${replyNo}`,
                    contentType: "application/json",
                    data: JSON.stringify({ replyContent: newContent }),
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    },
                    success: function() {
                        replyItem.find('span').eq(0).text(newContent);
                        alert('댓글이 수정되었습니다.');
                    },
                    error: function(xhr) {
                        alert('댓글 수정에 실패했습니다.');
                    }
                });
            }
        });
    });

    function confirmDelete(message) {
        return confirm(message);
    }
</script>
</body>
</html>