<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<th:block layout:fragment="css">
</th:block>


<th:block layout:fragment="script">
    <script th:inline="javascript">
        // 찜 목록에서 항목을 삭제하는 함수
        function deleteWish(wishNo) {
            // CSRF 토큰 설정
            const header = $("meta[name='_csrf_header']").attr('content');
            const token = $("meta[name='_csrf']").attr('content');

            if (!token || !header) {
                console.error("CSRF token or header is undefined.");
                alert("CSRF 토큰 또는 헤더가 정의되지 않았습니다.");
                return;
            }

            const url = "/dadog/wish/" + wishNo;

            // Ajax를 사용하여 서버에 삭제 요청
            $.ajax({
                url: url,
                type: "DELETE",
                contentType: "application/json",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(header, token);
                },
                dataType: "json",
                cache: false,
                success: function (result, status) {
                    alert("찜 목록에서 삭제되었습니다.");
                    location.reload();
                },
                error: function (xhr, status, error) {
                    console.log("error ===> " + status);
                    console.log("error ===>" + error);
                    if (xhr.status == '401') {
                        alert("로그인 후 이용해주세요");
                        location.href = "/dadog/login";
                    } else {
                        alert("에러가 발생하였습니다. \n 메인으로 돌아갑니다.");
                        location.href = "/dadog/main";
                    }
                }
            });
        }

        // 입양 신청을 처리하는 함수
        function adoptAnimal(button, adoptNo) {
            const confirmAdoption = confirm("입양신청을 하시겠습니까?\n[입양 신청 중에는 신청 취소가 불가능 합니다.]");

            if (confirmAdoption) {
                const header = $("meta[name='_csrf_header']").attr('content');
                const token = $("meta[name='_csrf']").attr('content');

                // Ajax를 사용하여 서버에 입양 신청 요청함.
                $.ajax({
                    url: `/dadog/adopt/${adoptNo}`,
                    type: "POST",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader(header, token);
                    },
                    success: function (result) {
                        alert("입양신청이 완료되었습니다.");
                        updateAdoptionStatus(button, adoptNo, true);
                    },
                    error: function (xhr, status, error) {
                        console.error("Error:", error);
                        if (xhr.status === 401) {
                            alert("로그인 후 이용해주세요");
                            location.href = "/dadog/login";
                        } else {
                            alert("입양신청 중 오류가 발생했습니다.");
                        }
                    }
                });
            } else {
                alert("입양신청이 취소되었습니다.");
            }
        }

        // 입양 신청 상태를 업데이트하는 함수
        function updateAdoptionStatus(button, adoptNo, isAdopted) {
            if (isAdopted) {
                button.innerText = "입양신청중";
                button.disabled = true;
                localStorage.setItem("adopted_" + adoptNo, "true");
            }
        }

        // 페이지 로드 시 입양 신청 상태를 초기화하는 함수
        function initAdoptionStatus() {
            const buttons = document.querySelectorAll("button[data-adopt-no]");
            buttons.forEach(button => {
                const adoptNo = button.getAttribute("data-adopt-no");
                const isAdopted = localStorage.getItem("adopted_" + adoptNo) === "true";

                if (isAdopted) {
                    button.innerText = "입양신청중";
                    button.disabled = true;
                }
            });
        }

        // 페이지 로드 시 initAdoptionStatus 함수 실행
        document.addEventListener("DOMContentLoaded", initAdoptionStatus);
    </script>
</th:block>
<div layout:fragment="mainContent">
    <!-- 에러 메시지 표시 -->
    <div th:if="${message}" th:text="${message}" style="color: red;"></div>
    <div>
        <!-- 찜 목록 테이블 -->
        <table class="table">
            <thead>
            <tr>
                <th>사진</th>
                <th>견종</th>
                <th>나이</th>
                <th>체중</th>
                <th>보호소 이름</th>
                <th>공고 종료일</th>
            </tr>
            </thead>
            <tbody>
            <!-- 찜 목록이 비어있을 경우 -->
            <tr th:if="${#lists.isEmpty(wishList)}">
                <td colspan="7">찜 목록이 없습니다.</td>
            </tr>
            <!-- 찜 목록 항목 -->
            <tr th:each="wish : ${wishList}">
                <td><img th:src="${wish.adopt.adoptImgUrl}" alt="입양 동물 이미지" style="width: 100px; height: auto;"></td>
                <td th:text="${wish.adopt.adoptKind}"></td>
                <td th:text="${wish.adopt.adoptAge}"></td>
                <td th:text="${wish.adopt.getAdoptWeight()}"></td>
                <td th:text="${wish.adopt.getAdoptCareNm()}"></td>
                <td th:text="${wish.adopt.getAdoptEdt()}"></td>
                <td>
                    <!-- 상세보기, 입양하기, 삭제 버튼 -->
                    <a th:href="@{/dadog/adopt/{adoptNo}(adoptNo=${wish.adopt.adoptNo})}" class="btn btn-primary">상세보기</a>
                    <button class="btn btn-success" type="button" th:onclick="adoptAnimal(this, [[${wish.adopt.adoptNo}]])" th:data-adopt-no="${wish.adopt.adoptNo}">입양하기</button>
                    <button class="btn btn-outline-dark" type="button" th:onclick="deleteWish([[${wish.wishNo}]])">삭제</button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
</html>